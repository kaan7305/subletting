// NestQuarter Database Schema
// Based on the platform design proposal

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// USERS & AUTHENTICATION
// ==========================================

model User {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email             String    @unique @db.VarChar(255)
  password_hash     String?   @db.VarChar(255)
  first_name        String    @db.VarChar(100)
  last_name         String    @db.VarChar(100)
  phone             String?   @db.VarChar(20)
  phone_verified    Boolean   @default(false)
  email_verified    Boolean   @default(false)
  date_of_birth     DateTime? @db.Date
  profile_photo_url String?   @db.Text
  bio               String?   @db.Text
  user_type         String    @db.VarChar(20) // 'guest', 'host', 'both'
  student_verified  Boolean   @default(false)
  id_verified       Boolean   @default(false)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now()) @updatedAt
  last_login        DateTime?

  // Relations
  student_verifications  StudentVerification[]
  identity_verifications IdentityVerification[]
  properties             Property[]              @relation("HostProperties")
  bookings_as_guest      Booking[]               @relation("GuestBookings")
  bookings_as_host       Booking[]               @relation("HostBookings")
  reviews_written        Review[]                @relation("ReviewerReviews")
  reviews_received       Review[]                @relation("RevieweeReviews")
  messages_sent          Message[]               @relation("SenderMessages")
  messages_received      Message[]               @relation("RecipientMessages")
  conversations_1        Conversation[]          @relation("Participant1Conversations")
  conversations_2        Conversation[]          @relation("Participant2Conversations")
  wishlists              Wishlist[]
  payout_methods         PayoutMethod[]
  payouts                Payout[]
  guarantee_claims       GuaranteeClaim[]
  notifications          Notification[]
  user_settings          UserSettings?
  bookings_cancelled     Booking[]               @relation("CancelledByUser")

  @@index([email])
  @@index([user_type])
  @@map("users")
}

model StudentVerification {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String    @db.Uuid
  university_name    String?   @db.VarChar(255)
  university_email   String?   @db.VarChar(255)
  student_id_photo_url String? @db.Text
  verification_status String   @default("pending") @db.VarChar(20) // pending, approved, rejected
  verified_at        DateTime?
  created_at         DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("student_verifications")
}

model IdentityVerification {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                   String    @db.Uuid
  id_type                   String?   @db.VarChar(50) // passport, drivers_license, national_id
  id_number_hash            String?   @db.VarChar(255)
  id_front_photo_url        String?   @db.Text
  id_back_photo_url         String?   @db.Text
  verification_status       String    @default("pending") @db.VarChar(20)
  verified_at               DateTime?
  provider                  String?   @db.VarChar(50) // 'stripe_identity', 'jumio', 'manual'
  provider_verification_id  String?   @db.VarChar(255)
  created_at                DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("identity_verifications")
}

// ==========================================
// PROPERTIES
// ==========================================

model Property {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  host_id               String    @db.Uuid
  title                 String    @db.VarChar(255)
  description           String    @db.Text
  property_type         String    @db.VarChar(50) // entire_place, private_room, shared_room

  // Location
  address_line1         String    @db.VarChar(255)
  address_line2         String?   @db.VarChar(255)
  city                  String    @db.VarChar(100)
  state_province        String?   @db.VarChar(100)
  postal_code           String?   @db.VarChar(20)
  country               String    @db.VarChar(100)
  latitude              Decimal?  @db.Decimal(10, 8)
  longitude             Decimal?  @db.Decimal(11, 8)

  // Details
  bedrooms              Int       @default(1)
  beds                  Int       @default(1)
  bathrooms             Decimal   @default(1.0) @db.Decimal(3, 1)
  square_meters         Int?
  max_guests            Int       @default(1)

  // Pricing
  monthly_price_cents   Int
  security_deposit_cents Int?
  cleaning_fee_cents    Int       @default(0)

  // Availability
  minimum_stay_weeks    Int       @default(2)
  maximum_stay_months   Int       @default(12)

  // Settings
  instant_book          Boolean   @default(false)
  cancellation_policy   String    @default("moderate") @db.VarChar(20) // flexible, moderate, strict

  // Status
  status                String    @default("draft") @db.VarChar(20) // draft, pending_review, active, inactive
  published_at          DateTime?

  // Nearest University (for quick queries)
  nearest_university_id    String?  @db.Uuid
  distance_to_university_km Decimal? @db.Decimal(5, 2)

  // Metadata
  created_at            DateTime  @default(now())
  updated_at            DateTime  @default(now()) @updatedAt

  // Relations
  host                  User                   @relation("HostProperties", fields: [host_id], references: [id], onDelete: Cascade)
  photos                PropertyPhoto[]
  amenities             PropertyAmenity[]
  universities          PropertyUniversity[]
  nearest_university    University?            @relation("NearestUniversity", fields: [nearest_university_id], references: [id], onDelete: SetNull)
  bookings              Booking[]
  booking_calendar      BookingCalendar[]
  reviews               Review[]
  wishlist_items        WishlistItem[]
  conversations         Conversation[]

  @@index([host_id])
  @@index([city])
  @@index([status])
  @@index([nearest_university_id])
  @@map("properties")
}

model PropertyPhoto {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  property_id   String   @db.Uuid
  photo_url     String   @db.Text
  caption       String?  @db.VarChar(255)
  display_order Int
  created_at    DateTime @default(now())

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@map("property_photos")
}

model Amenity {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String  @unique @db.VarChar(100)
  category   String? @db.VarChar(50) // essentials, facilities, features, location
  icon_name  String? @db.VarChar(50)

  properties PropertyAmenity[]

  @@map("amenities")
}

model PropertyAmenity {
  property_id String @db.Uuid
  amenity_id  String @db.Uuid

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
  amenity  Amenity  @relation(fields: [amenity_id], references: [id], onDelete: Cascade)

  @@id([property_id, amenity_id])
  @@map("property_amenities")
}

model University {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String   @db.VarChar(255)
  city       String   @db.VarChar(100)
  country    String   @db.VarChar(100)
  latitude   Decimal? @db.Decimal(10, 8)
  longitude  Decimal? @db.Decimal(11, 8)
  created_at DateTime @default(now())

  properties         PropertyUniversity[]
  nearest_properties Property[]           @relation("NearestUniversity")

  @@map("universities")
}

model PropertyUniversity {
  property_id     String  @db.Uuid
  university_id   String  @db.Uuid
  distance_km     Decimal? @db.Decimal(5, 2)
  transit_minutes Int?

  property   Property   @relation(fields: [property_id], references: [id], onDelete: Cascade)
  university University @relation(fields: [university_id], references: [id], onDelete: Cascade)

  @@id([property_id, university_id])
  @@map("property_universities")
}

// ==========================================
// BOOKINGS
// ==========================================

model Booking {
  id                       String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  property_id              String?   @db.Uuid
  guest_id                 String?   @db.Uuid
  host_id                  String?   @db.Uuid

  // Dates
  check_in_date            DateTime  @db.Date
  check_out_date           DateTime  @db.Date
  nights                   Int

  // Pricing
  subtotal_cents           Int
  service_fee_cents        Int
  cleaning_fee_cents       Int       @default(0)
  security_deposit_cents   Int?
  total_cents              Int

  // Payment
  payment_status           String    @default("pending") @db.VarChar(20) // pending, partial, completed, refunded
  payment_method           String?   @db.VarChar(50)
  stripe_payment_intent_id String?   @db.VarChar(255)

  // Status
  booking_status           String    @default("pending") @db.VarChar(20) // pending, confirmed, cancelled, completed
  cancellation_reason      String?   @db.Text
  cancelled_by             String?   @db.Uuid
  cancelled_at             DateTime?

  // Check-in details
  guest_count              Int       @default(1)
  purpose_of_stay          String?   @db.VarChar(50) // university, internship, research, travel
  special_requests         String?   @db.Text

  // Metadata
  created_at               DateTime  @default(now())
  updated_at               DateTime  @default(now()) @updatedAt
  confirmed_at             DateTime?

  // Relations
  property         Property?         @relation(fields: [property_id], references: [id], onDelete: SetNull)
  guest            User?             @relation("GuestBookings", fields: [guest_id], references: [id], onDelete: SetNull)
  host             User?             @relation("HostBookings", fields: [host_id], references: [id], onDelete: SetNull)
  cancelled_by_user User?            @relation("CancelledByUser", fields: [cancelled_by], references: [id])
  reviews          Review[]
  booking_calendar BookingCalendar[]
  payouts          Payout[]
  guarantee_claims GuaranteeClaim[]
  conversations    Conversation[]

  @@index([property_id])
  @@index([guest_id])
  @@index([check_in_date, check_out_date])
  @@index([booking_status])
  @@map("bookings")
}

model BookingCalendar {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  property_id String   @db.Uuid
  date        DateTime @db.Date
  status      String   @db.VarChar(20) // available, booked, blocked
  booking_id  String?  @db.Uuid

  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)
  booking  Booking? @relation(fields: [booking_id], references: [id], onDelete: SetNull)

  @@unique([property_id, date])
  @@index([property_id, date])
  @@map("booking_calendar")
}

// ==========================================
// REVIEWS
// ==========================================

model Review {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id             String    @db.Uuid
  property_id            String    @db.Uuid
  reviewer_id            String?   @db.Uuid
  reviewee_id            String?   @db.Uuid
  review_type            String    @db.VarChar(20) // guest_to_host, host_to_guest

  // Ratings (1-5)
  overall_rating         Decimal   @db.Decimal(2, 1)
  cleanliness_rating     Decimal?  @db.Decimal(2, 1)
  accuracy_rating        Decimal?  @db.Decimal(2, 1)
  location_rating        Decimal?  @db.Decimal(2, 1)
  communication_rating   Decimal?  @db.Decimal(2, 1)
  value_rating           Decimal?  @db.Decimal(2, 1)

  // Content
  review_text            String?   @db.Text

  // Status
  status                 String    @default("published") @db.VarChar(20) // published, hidden, flagged

  // Response
  host_response          String?   @db.Text
  host_responded_at      DateTime?

  created_at             DateTime  @default(now())
  updated_at             DateTime  @default(now()) @updatedAt

  // Relations
  booking  Booking        @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  property Property       @relation(fields: [property_id], references: [id], onDelete: Cascade)
  reviewer User?          @relation("ReviewerReviews", fields: [reviewer_id], references: [id], onDelete: SetNull)
  reviewee User?          @relation("RevieweeReviews", fields: [reviewee_id], references: [id], onDelete: SetNull)
  photos   ReviewPhoto[]

  @@index([property_id])
  @@index([reviewer_id])
  @@map("reviews")
}

model ReviewPhoto {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  review_id  String   @db.Uuid
  photo_url  String   @db.Text
  created_at DateTime @default(now())

  review Review @relation(fields: [review_id], references: [id], onDelete: Cascade)

  @@map("review_photos")
}

// ==========================================
// MESSAGING
// ==========================================

model Message {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String   @db.Uuid
  sender_id       String?  @db.Uuid
  recipient_id    String?  @db.Uuid
  message_text    String   @db.Text
  translated_text Json?    @db.JsonB
  read_at         DateTime?
  created_at      DateTime @default(now())

  conversation Conversation @relation(fields: [conversation_id], references: [id])
  sender       User?        @relation("SenderMessages", fields: [sender_id], references: [id], onDelete: SetNull)
  recipient    User?        @relation("RecipientMessages", fields: [recipient_id], references: [id], onDelete: SetNull)

  @@index([conversation_id])
  @@index([recipient_id, read_at])
  @@map("messages")
}

model Conversation {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  property_id      String?   @db.Uuid
  booking_id       String?   @db.Uuid
  participant_1_id String?   @db.Uuid
  participant_2_id String?   @db.Uuid
  last_message_at  DateTime  @default(now())
  created_at       DateTime  @default(now())

  property      Property? @relation(fields: [property_id], references: [id], onDelete: SetNull)
  booking       Booking?  @relation(fields: [booking_id], references: [id], onDelete: SetNull)
  participant_1 User?     @relation("Participant1Conversations", fields: [participant_1_id], references: [id], onDelete: SetNull)
  participant_2 User?     @relation("Participant2Conversations", fields: [participant_2_id], references: [id], onDelete: SetNull)
  messages      Message[]

  @@unique([participant_1_id, participant_2_id, property_id])
  @@map("conversations")
}

// ==========================================
// WISHLISTS
// ==========================================

model Wishlist {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  name       String   @default("My Wishlist") @db.VarChar(255)
  created_at DateTime @default(now())

  user  User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  items WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  wishlist_id String   @db.Uuid
  property_id String   @db.Uuid
  added_at    DateTime @default(now())

  wishlist Wishlist @relation(fields: [wishlist_id], references: [id], onDelete: Cascade)
  property Property @relation(fields: [property_id], references: [id], onDelete: Cascade)

  @@id([wishlist_id, property_id])
  @@map("wishlist_items")
}

// ==========================================
// PAYMENTS & PAYOUTS
// ==========================================

model PayoutMethod {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id           String   @db.Uuid
  method_type       String   @db.VarChar(50) // bank_account, paypal, stripe
  is_default        Boolean  @default(false)
  stripe_account_id String?  @db.VarChar(255)
  details           Json?    @db.JsonB
  created_at        DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("payout_methods")
}

model Payout {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  host_id             String?   @db.Uuid
  booking_id          String?   @db.Uuid
  amount_cents        Int
  platform_fee_cents  Int
  net_amount_cents    Int
  payout_status       String    @default("pending") @db.VarChar(20) // pending, processing, completed, failed
  payout_method_id    String?   @db.Uuid
  stripe_transfer_id  String?   @db.VarChar(255)
  scheduled_for       DateTime? @db.Date
  completed_at        DateTime?
  created_at          DateTime  @default(now())

  host    User?    @relation(fields: [host_id], references: [id], onDelete: SetNull)
  booking Booking? @relation(fields: [booking_id], references: [id], onDelete: SetNull)

  @@map("payouts")
}

model GuaranteeClaim {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id             String    @db.Uuid
  host_id                String?   @db.Uuid
  claim_type             String?   @db.VarChar(50) // property_damage, theft, cleaning
  description            String    @db.Text
  requested_amount_cents Int
  approved_amount_cents  Int?
  status                 String    @default("submitted") @db.VarChar(20) // submitted, under_review, approved, denied, paid
  evidence_photos        String[]  @db.Text
  resolution_notes       String?   @db.Text
  created_at             DateTime  @default(now())
  resolved_at            DateTime?

  booking Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  host    User?   @relation(fields: [host_id], references: [id], onDelete: SetNull)

  @@map("guarantee_claims")
}

// ==========================================
// NOTIFICATIONS & SETTINGS
// ==========================================

model Notification {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  type       String    @db.VarChar(50) // booking_request, message, review, payout, etc.
  title      String    @db.VarChar(255)
  message    String    @db.Text
  link_url   String?   @db.Text
  read_at    DateTime?
  created_at DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model UserSettings {
  user_id                String   @id @db.Uuid
  language               String   @default("en") @db.VarChar(10)
  currency               String   @default("USD") @db.VarChar(3)
  timezone               String   @default("UTC") @db.VarChar(50)
  email_notifications    Boolean  @default(true)
  sms_notifications      Boolean  @default(false)
  push_notifications     Boolean  @default(true)
  marketing_emails       Boolean  @default(true)
  booking_updates        Boolean  @default(true)
  message_notifications  Boolean  @default(true)
  profile_visibility     String   @default("public") @db.VarChar(20)
  show_email             Boolean  @default(false)
  show_phone             Boolean  @default(false)
  activity_status        Boolean  @default(true)
  two_factor_enabled     Boolean  @default(false)
  updated_at             DateTime @default(now()) @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_settings")
}
